---
export const prerender = false; // Enable live fetching on Vercel

import StoryLayout from '../../layouts/StoryLayout.astro';
import StoryPage from '../../components/StoryPage.astro';
import { db } from '../../lib/firebase';
import { collection, query, where, getDocs, limit } from 'firebase/firestore';

const { slug } = Astro.params;

// Fetch story from Firestore by slug IN REAL TIME
let story = null;
try {
  const q = query(collection(db, "stories"), where("slug", "==", slug), limit(1));
  const querySnapshot = await getDocs(q);
  if (!querySnapshot.empty) {
    story = querySnapshot.docs[0].data();
  }
} catch (e) {
  console.error("Error fetching story:", e);
}

if (!story) {
  return Astro.redirect('/404');
}

const ctaLink = story.ctaLinks?.global || '#'; 
---

<StoryLayout title={story.title} poster={story.coverImage} slug={slug}>
  {story.slides.map((slide, index) => (
    <StoryPage
      id={`page-${index}`}
      image={slide.imageUrl}
      title={slide.title}
      subtitle={slide.subtitle}
      ctaText={slide.ctaText}
      ctaLink={index === story.slides.length - 1 ? ctaLink : undefined} 
    />
  ))}
</StoryLayout>
