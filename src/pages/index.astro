---
export const prerender = false; // Enable live fetching on Vercel

import '../styles/global.css';
import { db } from '../lib/firebase';
import { collection, getDocs, query, orderBy } from 'firebase/firestore';
import Analytics from '@vercel/analytics/astro';

// This now runs LIVE on the server
const stories = [];
try {
  const q = query(collection(db, "stories"), orderBy("createdAt", "desc"));
  const querySnapshot = await getDocs(q);
  querySnapshot.forEach((doc) => {
    stories.push({ id: doc.id, ...doc.data() });
  });
} catch (e) {
  console.error("Error fetching stories:", e);
}
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<meta name="google-site-verification" content="ndArWblvpiAtgbP1AOwgLYYYLOQpSbmQ_ptE7H6GVx8" />
		<title>Web Stories</title>
	</head>
	<body class="bg-zinc-900 text-white min-h-screen p-6 font-sans">
    <div class="max-w-7xl mx-auto">
      <div class="flex justify-between items-center mb-10">
        <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
          Featured Stories
        </h1>
        <a href="/admin" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
          <span>+</span> Create Story
        </a>
      </div>
      
      {stories.length === 0 ? (
        <div class="text-center py-20 text-zinc-500">
           No stories found. Create your first one!
        </div>
      ) : (
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
          {stories.map(story => (
            <a href={`/stories/${story.slug}`} class="group relative bg-zinc-800 rounded-xl overflow-hidden hover:-translate-y-1 transition-transform duration-200 block shadow-lg">
              <div class="aspect-[9/16] w-full overflow-hidden">
                <img 
                  src={story.coverImage} 
                  alt={story.title} 
                  class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                />
              </div>
              <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent flex flex-col justify-end p-4">
                <h2 class="text-white font-bold text-lg leading-tight line-clamp-2">{story.title}</h2>
                <span class="text-xs text-zinc-300 mt-2 flex items-center gap-1">
                  <span>{story.slides?.length || 0} slides</span>
                  <span class="w-1 h-1 bg-zinc-500 rounded-full"></span>
                  <span>AMP</span>
                </span>
              </div>
            </a>
          ))}
        </div>
      )}
    </div>
    <Analytics />
	</body>
</html>
